/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import DocumentService from"@typo3/core/document-service.js";import $ from"jquery";import{SeverityEnum}from"@typo3/backend/enum/severity.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import Icons from"@typo3/backend/icons.js";import Modal from"@typo3/backend/modal.js";import MultiStepWizard from"@typo3/backend/multi-step-wizard.js";import"@typo3/backend/element/icon-element.js";import{topLevelModuleImport}from"@typo3/backend/utility/top-level-module-import.js";class Localization{constructor(){this.triggerButton=".t3js-localize",DocumentService.ready().then((()=>{this.initialize()}))}async initialize(){topLevelModuleImport("@typo3/backend/localization/provider-list.js"),$(this.triggerButton).removeClass("disabled"),$(document).on("click",this.triggerButton,(async e=>{e.preventDefault();const t=$(e.currentTarget),a=parseInt(t.data("pageId"),10),o=parseInt(t.data("languageId"),10),i=await(await this.getLocalizationProviders(a,o)).resolve();if(0===i.length)return void Modal.confirm(TYPO3.lang["window.localization.mixed_mode.title"],TYPO3.lang["window.localization.mixed_mode.message"],SeverityEnum.warning,[{text:TYPO3?.lang?.["button.ok"]||"OK",btnClass:"btn-warning",name:"ok",trigger:(e,t)=>t.hideModal()}]);const n=await(await this.loadAvailableLanguages(a,o)).resolve();if(1===i.length)MultiStepWizard.set("localizationMode",i[0]);else{const e=document.createElement("typo3-localization-wizard-provider-list");e.providers=i,MultiStepWizard.addSlide("localize-choose-action",TYPO3.lang["localize.wizard.header_page"].replace("{0}",t.data("page")).replace("{1}",t.data("languageName")),e,SeverityEnum.notice,TYPO3.lang["localize.wizard.step.selectMode"],((e,t)=>{void 0!==t.localizationMode&&MultiStepWizard.unlockNextStep()}))}1===n.length?MultiStepWizard.set("sourceLanguage",n[0].uid):MultiStepWizard.addSlide("localize-choose-language",TYPO3.lang["localize.view.chooseLanguage"],"",SeverityEnum.notice,TYPO3.lang["localize.wizard.step.chooseLanguage"],(async(e,t)=>{void 0!==t.sourceLanguage&&MultiStepWizard.unlockNextStep(),e.html('<div class="text-center">'+await Icons.getIcon("spinner-circle",Icons.sizes.large)+"</div>"),MultiStepWizard.getComponent().on("change",".t3js-language-option",(e=>{MultiStepWizard.set("sourceLanguage",$(e.currentTarget).val()),MultiStepWizard.unlockNextStep()}));const a=$("<div />",{class:"row"});for(const e of n){const t="language"+e.uid,o=$("<input />",{type:"radio",name:"language",id:t,value:e.uid,class:"btn-check t3js-language-option"}),i=$("<label />",{class:"btn btn-default btn-block",for:t}).text(" "+e.title).prepend(e.flagIcon);a.append($("<div />",{class:"col-sm-4"}).append(o).append(i))}e.empty().append(a)})),MultiStepWizard.addSlide("localize-summary",TYPO3.lang["localize.view.summary"],"",SeverityEnum.notice,TYPO3.lang["localize.wizard.step.selectRecords"],(async(e,a)=>{e.empty().html('<div class="text-center">'+await Icons.getIcon("spinner-circle",Icons.sizes.large)+"</div>");const o=await(await this.getSummary(parseInt(t.data("pageId"),10),parseInt(t.data("languageId"),10),a.sourceLanguage,a.localizationMode)).resolve();e.empty(),MultiStepWizard.set("records",[]);const i=o.columns.columns;o.columns.columnList.forEach((t=>{if(void 0===o.records[t])return;const n=i[t],l=document.createElement("div");l.classList.add("row","gy-2"),o.records[t].forEach((e=>{const t=" ("+e.uid+") "+e.title;a.records.push(e.uid);const o=document.createElement("div");o.classList.add("col-sm-6");const i=document.createElement("div");i.classList.add("input-group");const n=document.createElement("span");n.classList.add("input-group-text");const c=document.createElement("span");c.classList.add("form-check","form-check-type-toggle");const r=document.createElement("input");r.type="checkbox",r.id="record-uid-"+e.uid,r.classList.add("form-check-input","t3js-localization-toggle-record"),r.checked=!0,r.dataset.uid=e.uid.toString(),r.ariaLabel=t;const d=document.createElement("label");d.classList.add("form-control"),d.htmlFor="record-uid-"+e.uid,d.innerHTML=e.icon,d.appendChild(document.createTextNode(t)),c.appendChild(r),n.appendChild(c),i.appendChild(n),i.appendChild(d),o.appendChild(i),l.appendChild(o)}));const c=document.createElement("fieldset");c.classList.add("localization-fieldset");const r=document.createElement("div");r.classList.add("form-check","form-check-type-toggle");const d=document.createElement("input");d.classList.add("form-check-input","t3js-localization-toggle-column"),d.id="records-column-"+t,d.type="checkbox",d.checked=!0;const s=document.createElement("label");s.classList.add("form-check-label"),s.htmlFor="records-column-"+t,s.textContent=n,r.appendChild(d),r.appendChild(s),c.appendChild(r),c.appendChild(l),e.append(c)})),MultiStepWizard.unlockNextStep(),MultiStepWizard.getComponent().on("change",".t3js-localization-toggle-record",(e=>{const t=$(e.currentTarget),o=t.data("uid"),i=t.closest("fieldset"),n=i.find(".t3js-localization-toggle-column");if(t.is(":checked"))a.records.push(o);else{const e=a.records.indexOf(o);e>-1&&a.records.splice(e,1)}const l=i.find(".t3js-localization-toggle-record"),c=i.find(".t3js-localization-toggle-record:checked");n.prop("checked",c.length>0),n.prop("__indeterminate",c.length>0&&c.length<l.length),a.records.length>0?MultiStepWizard.unlockNextStep():MultiStepWizard.lockNextStep()})).on("change",".t3js-localization-toggle-column",(e=>{const t=$(e.currentTarget),a=t.closest("fieldset").find(".t3js-localization-toggle-record");a.prop("checked",t.is(":checked")),a.trigger("change")}))})),MultiStepWizard.addFinalProcessingSlide((async(e,a)=>{await this.localizeRecords(parseInt(t.data("pageId"),10),parseInt(t.data("languageId"),10),a.sourceLanguage,a.localizationMode,a.records),MultiStepWizard.dismiss(),document.location.reload()})).then((()=>{MultiStepWizard.show(),MultiStepWizard.getComponent().on("change",".t3js-localization-option",(e=>{MultiStepWizard.set("localizationMode",$(e.currentTarget).val()),MultiStepWizard.unlockNextStep()}))}))}))}getLocalizationProviders(e,t){return new AjaxRequest(TYPO3.settings.ajaxUrls.records_localize_providers).withQueryArguments({uid:e,languageId:t}).get()}loadAvailableLanguages(e,t){return new AjaxRequest(TYPO3.settings.ajaxUrls.page_languages).withQueryArguments({pageId:e,languageId:t}).get()}getSummary(e,t,a,o){return new AjaxRequest(TYPO3.settings.ajaxUrls.records_localize_summary).withQueryArguments({pageId:e,destLanguageId:t,languageId:a,localizationMode:o}).get()}localizeRecords(e,t,a,o,i){return new AjaxRequest(TYPO3.settings.ajaxUrls.records_localize).withQueryArguments({pageId:e,srcLanguageId:a,destLanguageId:t,action:o,uidList:i}).get()}}export default new Localization;