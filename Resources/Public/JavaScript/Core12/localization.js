/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
import DocumentService from"@typo3/core/document-service.js";import $ from"jquery";import{SeverityEnum}from"@typo3/backend/enum/severity.js";import AjaxRequest from"@typo3/core/ajax/ajax-request.js";import Icons from"@typo3/backend/icons.js";import Wizard from"@typo3/backend/wizard.js";import"@typo3/backend/element/icon-element.js";import{MarkupIdentifiers}from"@typo3/backend/enum/icon-types.js";import Modal from"@typo3/backend/modal.js";class Localization{constructor(){this.triggerButton=".t3js-localize",this.localizationMode=null,this.sourceLanguage=null,this.records=[],DocumentService.ready().then((()=>{this.initialize()}))}initialize(){$(this.triggerButton).removeClass("disabled"),$(document).on("click",this.triggerButton,(async e=>{e.preventDefault();const t=$(e.currentTarget),a=parseInt(t.data("pageId"),10),i=parseInt(t.data("languageId"),10),o=await(await this.getLocalizationProviders(a,i)).resolve();if(0===o.length)return void Modal.confirm(TYPO3.lang["window.localization.mixed_mode.title"],TYPO3.lang["window.localization.mixed_mode.message"],SeverityEnum.warning,[{text:TYPO3?.lang?.["button.ok"]||"OK",btnClass:"btn-warning",name:"ok",trigger:(e,t)=>t.hideModal()}]);const n='<div data-bs-toggle="buttons">'+(await Promise.all(o.map((async e=>this.createProviderMarkup(e))))).join("")+"</div>";Wizard.addSlide("localize-choose-action",TYPO3.lang["localize.wizard.header_page"].replace("{0}",t.data("page")).replace("{1}",t.data("languageName")),n,SeverityEnum.info,(()=>{1===o.length&&(this.localizationMode=o[0].identifier,Wizard.unlockNextStep().trigger("click"))})),Wizard.addSlide("localize-choose-language",TYPO3.lang["localize.view.chooseLanguage"],"",SeverityEnum.info,(e=>{Icons.getIcon("spinner-circle-dark",Icons.sizes.large).then((a=>{e.html('<div class="text-center">'+a+"</div>"),this.loadAvailableLanguages(parseInt(t.data("pageId"),10),parseInt(t.data("languageId"),10)).then((async t=>{const a=await t.resolve();if(1===a.length)return this.sourceLanguage=a[0].uid,void Wizard.unlockNextStep().trigger("click");Wizard.getComponent().on("click",".t3js-language-option",(e=>{const t=$(e.currentTarget).prev();this.sourceLanguage=t.val(),Wizard.unlockNextStep()}));const i=$("<div />",{class:"row"});for(const e of a){const t="language"+e.uid,a=$("<input />",{type:"radio",name:"language",id:t,value:e.uid,style:"display: none;",class:"btn-check"}),o=$("<label />",{class:"btn btn-default d-block t3js-language-option option",for:t}).text(" "+e.title).prepend(e.flagIcon);i.append($("<div />",{class:"col-sm-4"}).append(a).append(o))}e.empty().append(i)}))}))})),Wizard.addSlide("localize-summary",TYPO3.lang["localize.view.summary"],"",SeverityEnum.info,(e=>{Icons.getIcon("spinner-circle-dark",Icons.sizes.large).then((t=>{e.html('<div class="text-center">'+t+"</div>")})),this.getSummary(parseInt(t.data("pageId"),10),parseInt(t.data("languageId"),10)).then((async t=>{const a=await t.resolve();e.empty(),this.records=[];const i=a.columns.columns;a.columns.columnList.forEach((t=>{if(void 0===a.records[t])return;const o=i[t],n=$("<div />",{class:"row"});a.records[t].forEach((e=>{const t=" ("+e.uid+") "+e.title;this.records.push(e.uid),n.append($("<div />",{class:"col-sm-6"}).append($("<div />",{class:"input-group"}).append($("<span />",{class:"input-group-addon"}).append($("<input />",{type:"checkbox",class:"t3js-localization-toggle-record",id:"record-uid-"+e.uid,checked:"checked","data-uid":e.uid,"aria-label":t})),$("<label />",{class:"form-control",for:"record-uid-"+e.uid}).text(t).prepend(e.icon))))})),e.append($("<fieldset />",{class:"localization-fieldset"}).append($("<label />").text(o).prepend($("<input />",{class:"t3js-localization-toggle-column",type:"checkbox",checked:"checked"})),n))})),Wizard.unlockNextStep(),Wizard.getComponent().on("change",".t3js-localization-toggle-record",(e=>{const t=$(e.currentTarget),a=t.data("uid"),i=t.closest("fieldset"),o=i.find(".t3js-localization-toggle-column");if(t.is(":checked"))this.records.push(a);else{const e=this.records.indexOf(a);e>-1&&this.records.splice(e,1)}const n=i.find(".t3js-localization-toggle-record"),s=i.find(".t3js-localization-toggle-record:checked");o.prop("checked",s.length>0),o.prop("indeterminate",s.length>0&&s.length<n.length),this.records.length>0?Wizard.unlockNextStep():Wizard.lockNextStep()})).on("change",".t3js-localization-toggle-column",(e=>{const t=$(e.currentTarget),a=t.closest("fieldset").find(".t3js-localization-toggle-record");a.prop("checked",t.is(":checked")),a.trigger("change")}))}))})),Wizard.addFinalProcessingSlide((()=>{this.localizeRecords(parseInt(t.data("pageId"),10),parseInt(t.data("languageId"),10),this.records).then((()=>{Wizard.dismiss(),document.location.reload()}))})).then((()=>{Wizard.show(),Wizard.getComponent().on("click",".t3js-localization-option",(e=>{const t=$(e.currentTarget),a=t.find('input[type="radio"]');if(t.data("helptext")){const a=$(e.delegateTarget);a.find(".t3js-localization-option").removeClass("active"),a.find(".t3js-helptext").addClass("text-body-secondary"),t.addClass("active"),a.find(t.data("helptext")).removeClass("text-body-secondary")}this.localizationMode=a.val(),Wizard.unlockNextStep()}))}))}))}loadAvailableLanguages(e,t){return new AjaxRequest(TYPO3.settings.ajaxUrls.page_languages).withQueryArguments({pageId:e,languageId:t}).get()}getSummary(e,t){return new AjaxRequest(TYPO3.settings.ajaxUrls.records_localize_summary).withQueryArguments({pageId:e,destLanguageId:t,languageId:this.sourceLanguage,localizationMode:this.localizationMode}).get()}localizeRecords(e,t,a){return new AjaxRequest(TYPO3.settings.ajaxUrls.records_localize).withQueryArguments({pageId:e,srcLanguageId:this.sourceLanguage,destLanguageId:t,action:this.localizationMode,uidList:a}).get()}getLocalizationProviders(e,t){return new AjaxRequest(TYPO3.settings.ajaxUrls.records_localize_providers).withQueryArguments({uid:e,languageId:t}).get()}async createProviderMarkup(e){const t=await Icons.getIcon(e.icon,Icons.sizes.large,null,null,MarkupIdentifiers.inline);return Promise.resolve('<div class="row"><div class="col-sm-3"><label class="btn btn-default d-block t3js-localization-option" data-helptext=".t3js-helptext-translate">'+t+'<input type="radio" name="mode" id="'+e.identifier+'" value="'+e.identifier+'" style="display: none"><br>'+e.title+'</label></div><div class="col-sm-9"><p class="t3js-helptext t3js-helptext-translate text-body-secondary">'+e.description+"</p></div></div>")}}export default new Localization;